<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afirmaci√≥n del D√≠a - Positividad Diaria</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Recibe una afirmaci√≥n positiva cada d√≠a. Comparte tu energ√≠a positiva y conecta con una comunidad de bienestar.">
    <meta name="keywords" content="afirmaciones, positividad, bienestar, mindfulness, motivaci√≥n diaria">
    <meta name="author" content="Felipe">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tu-app.railway.app/">
    <meta property="og:title" content="Afirmaci√≥n del D√≠a - Positividad Diaria">
    <meta property="og:description" content="Recibe una afirmaci√≥n positiva cada d√≠a. Comparte tu energ√≠a positiva y conecta con una comunidad de bienestar.">
    <meta property="og:image" content="https://tu-app.railway.app/static/images/og-image.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tu-app.railway.app/">
    <meta property="twitter:title" content="Afirmaci√≥n del D√≠a - Positividad Diaria">
    <meta property="twitter:description" content="Recibe una afirmaci√≥n positiva cada d√≠a. Comparte tu energ√≠a positiva y conecta con una comunidad de bienestar.">
    <meta property="twitter:image" content="https://tu-app.railway.app/static/images/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ú®</text></svg>">
    
    <!-- Google Analytics (opcional - reemplaza con tu ID) -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'GA_MEASUREMENT_ID');
    </script> -->
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .container {
            max-width: 900px;
            width: 90%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none; /* Oculto hasta que se acepten las cookies */
        }
        
        .screen {
            display: none; /* Ocultar todas las pantallas por defecto */
            animation: fadeIn 0.8s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2, h3 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        h2 { font-size: 1.8rem; margin-bottom: 1rem; }
        p { font-size: 1.1rem; opacity: 0.9; }

        /* Estilos de Formularios y Botones */
        input[type="text"], textarea {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            margin: 1rem 0;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        button, input[type="submit"] {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:hover, input[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* Pantalla de Afirmaci√≥n */
        .affirmation-text {
            font-size: 2rem;
            font-weight: bold;
            margin: 2rem 0;
            line-height: 1.5;
        }
        .timer {
            font-size: 1.2rem;
            margin-top: 2rem;
            color: #ffeb3b;
        }

        /* Dashboard */
        .dashboard { text-align: left; }
        .daily-affirmation {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }
        .affirmation-display { font-size: 1.5rem; }
        .comment-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #ffeb3b;
        }
        .comment-card strong { color: #ffeb3b; }
        .comment-card .comment-text { margin: 0.5rem 0; }
        .comment-card .comment-time { font-size: 0.9rem; opacity: 0.8; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 1.5rem; width: 95%; }
            h2 { font-size: 1.5rem; }
            .affirmation-text { font-size: 1.6rem; }
            input[type="text"], textarea, button { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Pantalla 1: Cookies -->
    <div class="modal-overlay" id="cookieScreen">
        <div class="modal-content">
            <h1>üç™ Cookies Necesarias</h1>
            <p>Usamos cookies para recordar qui√©n eres y guardar tus comentarios de forma segura. ¬øAceptas?</p>
            <button onclick="handleCookies(true)">‚úÖ Aceptar y Continuar</button>
            <button onclick="handleCookies(false)" style="background: #dc3545;">‚ùå Rechazar</button>
        </div>
    </div>
    
    <!-- Pantalla de Rechazo -->
    <div class="modal-overlay" id="declinedScreen">
        <div class="modal-content">
            <h1>üòî Lo sentimos</h1>
            <p>La aplicaci√≥n no puede funcionar sin cookies. Si cambias de opini√≥n, por favor recarga la p√°gina.</p>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <div class="container">
        <!-- Pantalla 2: Nombre -->
        <div class="screen" id="nameScreen">
            <h2>¬°Bienvenido/a!</h2>
            <p>Para empezar, dinos c√≥mo te llamas.</p>
            <form id="nameForm">
                <input type="text" id="userName" placeholder="Escribe tu nombre aqu√≠" required>
                <button type="submit">Guardar y Continuar</button>
            </form>
        </div>

        <!-- Pantalla 3: Afirmaci√≥n -->
        <div class="screen" id="affirmationScreen">
            <h2>Tu afirmaci√≥n de hoy es:</h2>
            <p class="affirmation-text">{% if afirmacion %}{{ afirmacion }}{% else %}Cargando afirmaci√≥n...{% endif %}</p>
            <p class="timer">Reflexiona sobre esto... <span id="countdown">8</span></p>
        </div>

        <!-- Pantalla 4: Comentario -->
        <div class="screen" id="commentScreen">
            <h2>üí≠ Comparte tu energ√≠a</h2>
            <p>Deja un mensaje positivo inspirado en la afirmaci√≥n.</p>
            <form id="commentForm">
                {% csrf_token %}
                <input type="hidden" name="nombre_comentario" id="commentUserName">
                <textarea name="comentario" rows="4" placeholder="Escribe tu reflexi√≥n o mensaje..." required></textarea>
                <button type="submit">Compartir Mensaje</button>
            </form>
        </div>

        <!-- Pantalla 5: Dashboard -->
        <div class="screen" id="dashboard">
            <h2>üí¨ Mensajes de la Comunidad</h2>
            <div class="daily-affirmation">
                <h3>La afirmaci√≥n de hoy fue:</h3>
                <p class="affirmation-display">{% if afirmacion %}{{ afirmacion }}{% endif %}</p>
            </div>
            <div id="commentsContainer">
                {% for comment in comentarios %}
                    <div class="comment-card">
                        <strong>{{ comment.nombre_usuario }}</strong>
                        <div class="comment-text">{{ comment.texto }}</div>
                        <div class="comment-time">{{ comment.fecha_creacion|date:"H:i d/m/Y" }}</div>
                    </div>
                {% empty %}
                    <div class="comment-card">
                        <p>¬°S√© el primero en compartir un mensaje positivo hoy! üåü</p>
                    </div>
                {% endfor %}
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button onclick="shareApp()">üì± ¬°Comparte esta app!</button>
            </div>
        </div>
    </div>

    <script>
        // --- Estado de la App ---
        let currentUser = '';

        // --- Selectores de Elementos ---
        const screens = {
            cookie: document.getElementById('cookieScreen'),
            declined: document.getElementById('declinedScreen'),
            container: document.querySelector('.container'),
            name: document.getElementById('nameScreen'),
            affirmation: document.getElementById('affirmationScreen'),
            comment: document.getElementById('commentScreen'),
            dashboard: document.getElementById('dashboard')
        };

        const forms = {
            name: document.getElementById('nameForm'),
            comment: document.getElementById('commentForm')
        };

        // --- L√≥gica de Flujo ---
        function showScreen(screenName) {
            // 1. Ocultar todo primero para evitar superposiciones
            screens.cookie.style.display = 'none';
            screens.declined.style.display = 'none';
            screens.container.style.display = 'none';
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');

            // 2. Mostrar lo correcto
            if (screenName === 'cookie' || screenName === 'declined') {
                screens[screenName].style.display = 'flex';
            } else {
                screens.container.style.display = 'block';
                if (screens[screenName]) {
                    screens[screenName].style.display = 'block';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const consent = localStorage.getItem('cookieConsent');
            const showDashboardFlag = sessionStorage.getItem('showDashboardAfterComment');

            if (showDashboardFlag === 'true') {
                // El usuario acaba de comentar, va directo al dashboard
                sessionStorage.removeItem('showDashboardAfterComment');
                currentUser = localStorage.getItem('userName');
                showScreen('dashboard');
                return; // Finaliza la ejecuci√≥n aqu√≠
            }
            
            if (consent === 'accepted') {
                currentUser = localStorage.getItem('userName');
                if (currentUser) {
                    showScreen('affirmation');
                    startAffirmationTimer();
                } else {
                    showScreen('name');
                }
            } else if (consent === 'declined') {
                showScreen('declined');
            } else {
                showScreen('cookie');
            }
        });

        function handleCookies(accepted) {
            if (accepted) {
                localStorage.setItem('cookieConsent', 'accepted');
                showScreen('name');
            } else {
                localStorage.setItem('cookieConsent', 'declined');
                showScreen('declined');
            }
        }

        forms.name.addEventListener('submit', (e) => {
            e.preventDefault();
            currentUser = document.getElementById('userName').value.trim();
            if (currentUser) {
                localStorage.setItem('userName', currentUser);
                showScreen('affirmation');
                startAffirmationTimer();
            }
        });
        
        function startAffirmationTimer() {
            let seconds = 8;
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = seconds;

            const timer = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(timer);
                    showScreen('comment');
                }
            }, 1000);
        }

        forms.comment.addEventListener('submit', (e) => {
            e.preventDefault();
            const commentUserName = document.getElementById('commentUserName');
            commentUserName.value = currentUser; // Asignar nombre de usuario actual
            
            const formData = new FormData(forms.comment);
            const submitButton = forms.comment.querySelector('button');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            fetch('', {
                method: 'POST',
                body: new URLSearchParams(formData).toString(),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest' // FIX: Identifica la petici√≥n como AJAX para Django
                }
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(data => {
                console.log(data.mensaje);
                // Poner bandera para mostrar el dashboard en la siguiente carga y recargar
                sessionStorage.setItem('showDashboardAfterComment', 'true');
                window.location.reload();
            })
            .catch(err => {
                console.error('Error al enviar comentario:', err);
                alert('Hubo un error al enviar tu comentario. Por favor, int√©ntalo de nuevo.');
                submitButton.disabled = false;
                submitButton.textContent = 'Compartir Mensaje';
            });
        });

        function shareApp() {
            if (navigator.share) {
                navigator.share({
                    title: 'Afirmaci√≥n del D√≠a ‚ú®',
                    text: '¬°Descubre tu afirmaci√≥n positiva diaria!',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('¬°Link copiado al portapapeles!');
                });
            }
        }
    </script>
</body>
</html> 